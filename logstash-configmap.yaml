apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-pipeline
data:
  logstash.conf: |
    input {
      beats {
        port => 5044
      }
    }

    filter {
      if [event][module] == "heartbeat" or "heartbeat" in [tags] or [monitor] {
        mutate {
          # First wipe any existing (wrong) data_stream fields
          remove_field => [ "[data_stream][type]" "[data_stream][dataset]" "[data_stream][namespace]" ]

          # Now set the correct synthetics-* values â€“ this syntax is bullet-proof
          add_field => {
            "[data_stream][type]"       => "synthetics"
            "[data_stream][namespace]"  => "default"
          }

          # Dataset per monitor type
          if [monitor][type] == "tcp" {
            add_field => { "[data_stream][dataset]" => "tcp" }
          }
          else if [monitor][type] == "http" {
            add_field => { "[data_stream][dataset]" => "http" }
          }
          else if [monitor][type] == "browser" {
            add_field => { "[data_stream][dataset]" => "browser" }
          }
          else if [monitor][type] == "icmp" {
            add_field => { "[data_stream][dataset]" => "icmp" }
          }
          else {
            add_field => { "[data_stream][dataset]" => "%{[monitor][type]}" }
          }

          add_tag => [ "via_logstash" "synthetics" ]
        }
      }
    }

    output {
      elasticsearch {
        hosts => [ "https://elasticsearch.yourdomain.com:9200" ]   # your actual endpoint(s)

        user => "elastic"
        password => "${ES_PASSWORD}"

        # This enables data stream mode and auto-routing
        data_stream => true
        data_stream_auto_routing => true

        ssl => true
        ssl_verification_mode => "certificate"   # or "full"
        cacert => "/etc/logstash/certs/ca.crt"
      }

      # Remove in production
      stdout { codec => rubydebug }
    }
